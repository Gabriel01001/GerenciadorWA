<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapFlow | Gest√£o Online</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%2310b981%22/><path d=%22M55 20 L35 50 L50 50 L45 80 L65 50 L50 50 L55 20 Z%22 fill=%22white%22/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* DESIGN PREMIUM (Igual V18) */
        :root { --primary: #10b981; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --card: #fff; --radius: 12px; }
        * { box-sizing: border-box; } body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e5e7eb; border-radius: var(--radius); font-family: inherit; }
        button { width: 100%; padding: 12px; border: none; border-radius: var(--radius); background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { filter: brightness(0.9); transform: translateY(-2px); }
        button.danger { background: var(--danger); } button.secondary { background: #e5e7eb; color: var(--text); }
        .card { background: #fff; border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 8px; display: flex; justify-content: space-between; border-radius: var(--radius); align-items: center; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .alert { background: #fff7ed; color: #9a3412; padding: 15px; border-radius: var(--radius); border: 1px solid #fdba74; margin-bottom: 20px; display: none; }
        
        /* Spinner de Carregamento */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-screen" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <h1 style="font-size: 3rem; margin: 0;">‚ö°</h1>
            <h2 style="margin: 0 0 20px;">ZapFlow</h2>
            <input type="text" id="user" placeholder="Usu√°rio">
            <input type="password" id="pass" placeholder="Senha">
            <button onclick="conectarBanco()">Entrar</button>
            <div id="loading" class="loader"></div>
            <p id="msg-login" style="color: red; margin-top: 10px; font-size: 14px;"></p>
            
            <div style="margin-top: 30px; font-size: 12px; color: #888;">
                <p>Suporte: <a href="https://wa.me/5521970458286" target="_blank" style="color: var(--primary); text-decoration: none;">WhatsApp</a></p>
            </div>
        </div>

        <div id="app-screen" class="hidden">
            <div id="vencimento-alert" class="alert">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Seu acesso expira em <span id="dias-restantes">0</span> dias.
                <button onclick="copiarPix()" style="width: auto; margin-left: 10px; padding: 5px 10px; font-size: 12px; background: #ea580c;">Pagar Pix</button>
            </div>

            <div class="header">
                <div>
                    <h3 id="ola-user" style="margin:0">...</h3>
                    <small id="status-acesso" style="color: #666;">...</small>
                </div>
                <div>
                    <button onclick="logout()" class="danger" style="width: auto;">Sair</button>
                </div>
            </div>

            <div style="background: #f9fafb; padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
                <h4 style="margin-top:0">üì• Adicionar</h4>
                <textarea id="links-input" rows="3" placeholder="Cole os links/n√∫meros aqui..."></textarea>
                <div style="display: flex; gap: 10px;">
                    <button onclick="document.getElementById('file').click()" class="secondary">üìÇ Arquivo</button>
                    <input type="file" id="file" accept=".txt" hidden onchange="lerArquivo(this)">
                    <button onclick="addLinks()">Carregar</button>
                </div>
            </div>

            <h4 style="color: var(--primary);">Pendentes (<span id="count-pend">0</span>)</h4>
            <div id="lista-pendentes"></div>
            
            <h4 style="color: #3b82f6; margin-top: 30px;">Salvos (<span id="count-saved">0</span>)</h4>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button onclick="baixarSalvos()" class="secondary" style="font-size: 12px;">üì• Baixar Lista</button>
                <button onclick="limparSalvos()" class="danger" style="font-size: 12px;">üóëÔ∏è Limpar</button>
            </div>
            <div id="lista-salvos"></div>
        </div>
    </div>

    <script>
        // =======================================================
        // üü¢ CONFIGURA√á√ÉO DO BANCO DE DADOS (PLANILHA)
        // =======================================================
        // Cole abaixo o link que voc√™ copiou do Google Sheets (Publicar na Web > CSV)
        
        const PLANILHA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgml7_32q0TOdv8FtFUh-aUFj0WDMD4JiPNziIvpncAE_BHeATOwxsSX6L0iUcak79TdR45sVi8qSz/pub?output=csv';

        // =======================================================
        
        const DB_KEY = 'zapflow_v19_cloud';
        let currentUser = null;
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || {};

        function salvarLocal() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

        // --- CONEX√ÉO COM A PLANILHA ---
        function conectarBanco() {
            const btn = document.querySelector('button');
            const loader = document.getElementById('loading');
            const msg = document.getElementById('msg-login');
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();

            if(!u || !p) { msg.innerText = "Preencha tudo."; return; }
            if(PLANILHA_URL.includes('COLE_SEU_LINK')) { msg.innerText = "Erro: Configure o link da planilha no c√≥digo."; return; }

            // Efeito visual
            btn.style.display = 'none';
            loader.style.display = 'block';
            msg.innerText = "";

            fetch(PLANILHA_URL)
                .then(response => response.text())
                .then(data => {
                    const linhas = data.split('\n');
                    let usuarioEncontrado = null;

                    // Ignora a primeira linha (cabe√ßalho)
                    for (let i = 1; i < linhas.length; i++) {
                        const colunas = linhas[i].split(',');
                        if (colunas.length >= 3) {
                            const planilhaUser = colunas[0].trim();
                            const planilhaPass = colunas[1].trim();
                            const planilhaDate = colunas[2].trim();

                            if (planilhaUser === u && planilhaPass === p) {
                                usuarioEncontrado = { user: planilhaUser, validade: planilhaDate };
                                break;
                            }
                        }
                    }

                    if (usuarioEncontrado) {
                        validarAcesso(usuarioEncontrado);
                    } else {
                        throw new Error("Usu√°rio ou senha incorretos.");
                    }
                })
                .catch(error => {
                    msg.innerText = error.message.includes("fetch") ? "Erro de conex√£o." : error.message;
                    btn.style.display = 'block';
                    loader.style.display = 'none';
                });
        }

        function validarAcesso(dados) {
            const hoje = new Date();
            const validade = new Date(dados.validade);
            
            if (dados.user !== 'admin' && hoje > validade) {
                document.getElementById('msg-login').innerText = "Acesso vencido! Renove via Pix.";
                document.querySelector('button').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // Sucesso
            currentUser = dados.user;
            if (!db[currentUser]) db[currentUser] = { links: [], salvos: [] };
            salvarLocal();
            entrarNoApp(dados.user, validade);
        }

        function entrarNoApp(user, dataValidade) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('ola-user').innerText = "Ol√°, " + user;
            
            if (user === 'admin') {
                document.getElementById('status-acesso').innerText = "Modo Admin (Gest√£o pela Planilha)";
                document.getElementById('vencimento-alert').style.display = 'none';
            } else {
                const diff = Math.ceil((dataValidade - new Date()) / (1000 * 60 * 60 * 24));
                document.getElementById('status-acesso').innerText = `Vence em: ${dataValidade.toLocaleDateString('pt-BR')}`;
                
                if (diff <= 3) {
                    document.getElementById('vencimento-alert').style.display = 'block';
                    document.getElementById('dias-restantes').innerText = diff;
                } else {
                    document.getElementById('vencimento-alert').style.display = 'none';
                }
            }
            renderizar();
        }

        function logout() { location.reload(); }

        // --- LINKS ---
        function addLinks() {
            const txt = document.getElementById('links-input');
            const lines = txt.value.split('\n');
            lines.forEach(l => { if(l.trim()) db[currentUser].links.push(l.trim()); });
            txt.value = ''; salvarLocal(); renderizar();
        }

        function lerArquivo(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                lines.forEach(l => { if(l.trim()) db[currentUser].links.push(l.trim()); });
                salvarLocal(); renderizar();
            };
            reader.readAsText(file);
            input.value = '';
        }

        function abrirLink(idx) {
            const link = db[currentUser].links[idx];
            let url = link.includes('http') ? link : `https://wa.me/55${link.replace(/\D/g,'')}`;
            window.open(url, '_blank');
            
            if(confirm(`Link aberto!\nDeseja salvar "${link}"?`)) {
                db[currentUser].salvos.push(link);
            }
            db[currentUser].links.splice(idx, 1);
            salvarLocal(); renderizar();
        }

        function limparSalvos() {
            if(confirm("Apagar todos os salvos?")) { db[currentUser].salvos = []; salvarLocal(); renderizar(); }
        }

        function baixarSalvos() {
            const blob = new Blob([db[currentUser].salvos.join('\n')], {type: "text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `salvos_${currentUser}.txt`;
            a.click();
        }

        function copiarPix() {
            const chave = "144.352.427-10";
            navigator.clipboard.writeText(chave);
            alert("Chave CPF copiada: " + chave + "\nBanco: Nu Bank\nFavorecido: Gabriel Martins Barbosa");
        }

        function renderizar() {
            const pend = document.getElementById('lista-pendentes');
            const salv = document.getElementById('lista-salvos');
            pend.innerHTML = ''; salv.innerHTML = '';
            
            document.getElementById('count-pend').innerText = db[currentUser].links.length;
            document.getElementById('count-saved').innerText = db[currentUser].salvos.length;

            db[currentUser].links.forEach((l, i) => {
                pend.innerHTML += `<div class="card">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70%;">${l}</span>
                    <button onclick="abrirLink(${i})" style="width:auto; padding:5px 15px;">Abrir ‚Üó</button>
                </div>`;
            });

            db[currentUser].salvos.forEach((l, i) => {
                salv.innerHTML += `<div class="card" style="border-left:4px solid var(--primary)">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:80%;">${l}</span>
                    <button onclick="db['${currentUser}'].salvos.splice(${i},1); salvarLocal(); renderizar();" class="danger" style="width:auto; padding:5px 10px;">X</button>
                </div>`;
            });
        }
    </script>
</body>
</html>
